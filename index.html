<html>
  <head>
    <style>
      .wrapped {
        overflow-wrap: break-word;
      }
    </style>
    <script src="big-number.js"></script>
    <script>
      const num2exp68 = new BigNumber();
      num2exp68.head.value = 1;
      for (let i = 0; i < 68; i++) {
        num2exp68.mul(2);
      }
      
      let number = localStorage.getItem("num") ? BigNumber.retrieve(localStorage.getItem("num")) : new BigNumber();
      let n;
      if (number.chunks === 1 && number.head.value <= 1) {
        number.head.value = 2;
      }
      if (number.compare(num2exp68) > 0) {
        number = num2exp68;
      }
      
      function iterate() {
        if (!n) {
          n = number.copy();
        }
        n.apply3n1();
        const comp = number.compare(n);
        if (comp === 0) {
            if (n.chunks === 1 && (n.head.value === 1 || n.head.value === 2 || n.head.value === 4)) {
                nextNumber(number);
                return false;
            }
            console.log("Number:", number.toString(), ". n:", n.toString());
            console.log("cycle:", number.toString());
            return true;
        } else if (comp < 0) {
            nextNumber(number);
            n = null;
            return false;
        } else {
            return false;
        }
      }
      
      function nextNumber(number) {
        if (number.even()) {
          number.increment();
        } else {
          number.increment(2);
        }
      }
      
      function loop() {
        const start = performance.now();
        while(performance.now() - start < 30) {
          if (iterate()) {
            return;
          }
        }
        const numString = number.toString();
        localStorage.setItem("num", numString);
        document.getElementById("increment-div").textContent = numString;
        document.getElementById("increment-div-calc").textContent = n === null ? "" : n.toString();
        requestAnimationFrame(loop);
      }
      
      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("increment-div").textContent = number.toString();
        loop(0);
      });
    </script>
  </head>

  <body>
    <div class="wrapped" id="increment-div"></div>
    <br>
    <div class="wrapped" id="increment-div-calc"></div>
    
  </body>
</html>
